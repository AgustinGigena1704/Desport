# .github/workflows/deploy.yml
name: Deploy API y Blazor

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # Job 1: Trigger deploy de API en Render
  deploy-api-render:
    name: Deploy API a Render
    runs-on: ubuntu-latest
    
    steps:
    - name: Trigger Render Deploy
      run: |
        echo "üöÄ Triggering Render deploy..."
        curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
    
    - name: Wait for deployment
      run: |
        echo "‚è≥ Esperando que Render termine el deploy..."
        sleep 30

  # Job 2: Deploy Blazor WebAssembly a GitHub Pages
  deploy-blazor:
    name: Deploy Blazor a GitHub Pages
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore src/CCC/CCC.csproj
    
    - name: Publish Blazor WebAssembly
      run: |
        dotnet publish src/CCC/CCC.csproj \
          -c Release \
          -o publish \
          /p:GHPages=true
    
    - name: Configurar para GitHub Pages
      run: |
        # Obtener nombre del repo
        REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
        
        # Cambiar base href en index.html
        sed -i "s|<base href=\"/home\" />|<base href=\"/$REPO_NAME/\" />|g" publish/wwwroot/index.html
        
        # A√±adir .nojekyll
        touch publish/wwwroot/.nojekyll
        
        # Crear 404.html para SPA routing
        cp publish/wwwroot/index.html publish/wwwroot/404.html
        
        echo "‚úÖ Configuraci√≥n completada para: /$REPO_NAME/"
    
    - name: Configurar URL de API
      run: |
        # Crear/actualizar appsettings.json con la URL de producci√≥n de Render
        cat > publish/wwwroot/appsettings.json <<EOF
        {
          "ApiBaseUrl": "${{ secrets.API_BASE_URL }}"
        }
        EOF
        
        echo "‚úÖ API configurada: ${{ secrets.API_BASE_URL }}"
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'publish/wwwroot'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Resumen del Deploy
      run: |
        echo "üöÄ Deploy completado!"
        echo "üì± Frontend: ${{ steps.deployment.outputs.page_url }}"
        echo "üîå API: ${{ secrets.API_BASE_URL }}"

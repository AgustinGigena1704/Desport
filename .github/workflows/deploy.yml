# .github/workflows/deploy.yml
name: Deploy API y Blazor

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  # Nombre del proyecto Blazor dentro de src/ (ej. CCC)
  BLAZOR_PROJECT_NAME: CCC 

jobs:
  # Job 1: Trigger deploy de API en Render
  deploy-api-render:
    name: Deploy API a Render
    runs-on: ubuntu-latest
    
    steps:
    - name: Trigger Render Deploy
      run: |
        echo "ðŸš€ Triggering Render deploy..."
        # Usar curl de forma mÃ¡s simple, POST es el mÃ©todo por defecto si hay datos, pero para un webhook simple, GET/POST sin cuerpo funciona.
        # Es mejor usar el mÃ©todo explÃ­cito POST si el webhook lo requiere.
        curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
    
    - name: Wait for deployment
      run: |
        echo "â³ Esperando que Render termine el deploy..."
        # Considera usar una acciÃ³n que espere una URL especÃ­fica, o aumentar el tiempo si la API tarda en arrancar.
        sleep 60 # Aumentado a 60 segundos por seguridad.

  # Job 2: Deploy Blazor WebAssembly a GitHub Pages
  deploy-blazor:
    name: Deploy Blazor a GitHub Pages
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore src/${{ env.BLAZOR_PROJECT_NAME }}/${{ env.BLAZOR_PROJECT_NAME }}.csproj
    
    - name: Publish Blazor WebAssembly
      run: |
        # Obtener nombre del repositorio para la base href
        REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
        
        dotnet publish src/${{ env.BLAZOR_PROJECT_NAME }}/${{ env.BLAZOR_PROJECT_NAME }}.csproj \
          -c Release \
          -o publish \
          /p:GHPages=true \
          /p:BasePath=/$REPO_NAME/ # Â¡IMPORTANTE! Esto configura correctamente la base href.
        
        echo "âœ… Blazor WebAssembly publicado con BasePath=/$REPO_NAME/"

    - name: Configurar para GitHub Pages
      run: |
        # AÃ±adir .nojekyll (ya no necesitamos tocar index.html porque BasePath lo maneja)
        touch publish/wwwroot/.nojekyll
        
        # Crear 404.html para SPA routing
        cp publish/wwwroot/index.html publish/wwwroot/404.html
        
        echo "âœ… ConfiguraciÃ³n adicional de GitHub Pages completada."
    
    - name: Configurar URL de API
      run: |
        # Crear/actualizar appsettings.json con la URL de producciÃ³n de Render
        cat > publish/wwwroot/appsettings.json <<EOF
        {
          "ApiBaseUrl": "${{ secrets.API_BASE_URL }}"
        }
        EOF
        
        echo "âœ… API configurada: ${{ secrets.API_BASE_URL }}"
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'publish/wwwroot'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Resumen del Deploy
      run: |
        echo "ðŸš€ Deploy completado!"
        echo "ðŸ“± Frontend: ${{ steps.deployment.outputs.page_url }}"
        echo "ðŸ”Œ API: ${{ secrets.API_BASE_URL }}"
